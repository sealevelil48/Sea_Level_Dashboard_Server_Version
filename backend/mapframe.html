<!DOCTYPE html>
<html>
<head>
    <title>GOVMAP - Sea Level Stations</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>
    <script>
        // Edge compatibility polyfill
        if (!window.fetch) {
            window.fetch = function(url, options) {
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(options && options.method || 'GET', url);
                    xhr.onload = function() {
                        resolve({
                            ok: xhr.status >= 200 && xhr.status < 300,
                            json: function() { return Promise.resolve(JSON.parse(xhr.responseText)); }
                        });
                    };
                    xhr.onerror = reject;
                    xhr.send(options && options.body);
                });
            };
        }
    </script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100%; height: 500px; }
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 500px; 
            background: #f0f0f0;
            color: #333;
        }
        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 500px;
            background: #ffe6e6;
            color: #d00;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>Loading GovMap...</div>
    </div>
    <div id="map" style="display: none;"></div>
    <div id="error" class="error" style="display: none;">
        <div>
            <h3>GovMap Unavailable</h3>
            <p>Unable to load GovMap API or station data</p>
        </div>
    </div>
    <script>
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('map').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
            console.error('GovMap Error:', message);
        }
        
        function showMap() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('map').style.display = 'block';
        }
        
        // IMS Code Translation Functions
        const seaStateCodes = {
            10: "Calm", 20: "Rippled", 30: "Smooth", 40: "Smooth to slight", 50: "Slight",
            55: "Slight to moderate", 60: "Moderate", 70: "Moderate to rough", 80: "Rough",
            90: "Rough to very rough", 110: "Very rough", 120: "Very rough to high",
            130: "High", 140: "High to very high", 150: "Very high", 160: "Phenomenal"
        };
        
        const windDirections = {
            045: "NE", 090: "E", 135: "SE", 180: "S", 225: "SW", 270: "W", 315: "NW", 360: "N"
        };
        
        function translateWaveHeight(waveString) {
            if (!waveString || typeof waveString !== 'string') return waveString;
            
            const parts = waveString.split(' / ');
            if (parts.length !== 2) {
                const code = parseInt(waveString.trim());
                return seaStateCodes[code] || waveString;
            }
            
            const code1 = parseInt(parts[0].trim());
            const code2 = parseInt(parts[1].trim());
            const trans1 = seaStateCodes[code1] || parts[0].trim();
            const trans2 = seaStateCodes[code2] || parts[1].trim();
            
            return trans1 + ' / ' + trans2;
        }
        
        function translateWindInfo(windString) {
            if (!windString || typeof windString !== 'string') return windString;
            
            const parts = windString.split('/');
            if (parts.length !== 2) return windString;
            
            const directions = parts[0];
            const speeds = parts[1];
            
            let translatedDirections = directions;
            if (directions.includes('-')) {
                const dirParts = directions.split('-');
                const dir1 = parseInt(dirParts[0]);
                const dir2 = parseInt(dirParts[1]);
                const trans1 = windDirections[dir1] || dirParts[0];
                const trans2 = windDirections[dir2] || dirParts[1];
                translatedDirections = trans1 + '-' + trans2;
            } else {
                const dir = parseInt(directions);
                translatedDirections = windDirections[dir] || directions;
            }
            
            return translatedDirections + ' / ' + speeds + ' kt';
        }
        
        let mapInstance;
        let stationsData = [];
        let forecastData = [];
        
        // Initialize translation functions globally
        window.translateWaveHeight = translateWaveHeight;
        window.translateWindInfo = translateWindInfo;
        
        window.onload = function() {
            // Add delay for Edge browser
            setTimeout(function() {
                try {
                    if (typeof govmap === 'undefined') {
                        throw new Error('GovMap API not loaded');
                    }
                
                govmap.token = "11aa3021-4ae0-4771-8ae0-df75e73fe73e";
                
                const convertToITM = (lon, lat) => {
                    const x = 219529 + (lon - 35.2045) * 111320 * Math.cos(lat * Math.PI / 180);
                    const y = 626907 + (lat - 31.7344) * 111320;
                    return { x: Math.round(x), y: Math.round(y) };
                };
                
                const displayAllMarkers = () => {
                    if (stationsData.length === 0) return;
                    
                    const wkts = [];
                    const names = [];
                    const symbols = [];
                    const tooltips = [];
                    const bubbleHTMLParameters = [];
                    
                    // Station to forecast mapping
                    const stationForecastMap = {
                        'Acre': 'Northern Coast',
                        'Yafo': 'Central Coast', 
                        'Ashkelon': 'Southern Coast',
                        'Eilat': 'Gulf of Eilat'
                    };
                    
                    // Add stations with combined data
                    stationsData.forEach((station) => {
                        wkts.push(`POINT(${station.x} ${station.y})`);
                        names.push(`station_${station.Station}`);
                        symbols.push({
                            url: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#2196F3"/></svg>'),
                            width: 32,
                            height: 32
                        });
                        
                        // Find matching forecast data
                        const forecastLocation = stationForecastMap[station.Station];
                        const matchingForecast = forecastData.find(f => f.name_eng === forecastLocation);
                        
                        if (matchingForecast) {
                            const currentForecast = matchingForecast.forecasts[0];
                            tooltips.push(`${station.Station} - Combined Data`);
                            
                            const waveHeight = translateWaveHeight(currentForecast?.elements?.wave_height || 'N/A');
                            const windInfo = translateWindInfo(currentForecast?.elements?.wind || 'N/A');
                            
                            const forecastHTML = `<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                                <h4 style="margin: 0 0 10px 0; color: #ff8c00;">${forecastLocation}</h4>
                                <div><strong>Wave Height:</strong> ${waveHeight}</div>
                                <div><strong>Sea Temperature:</strong> ${currentForecast?.elements?.sea_temperature || 'N/A'}°C</div>
                                <div><strong>Wind:</strong> ${windInfo}</div>
                                <div style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">
                                    <strong>Forecast Period:</strong><br>${currentForecast?.from || 'N/A'} - ${currentForecast?.to || 'N/A'}
                                </div>
                                <div style="font-size: 11px; color: #888; margin-top: 5px;">
                                    <a href="https://ims.gov.il/he/coasts" target="_parent" style="color: #666; text-decoration: none;">IMS Forecast ©</a>
                                </div>`;
                            
                            bubbleHTMLParameters.push([
                                station.Station,
                                `<strong>Sea Level:</strong> ${station.latest_value} m`,
                                `<strong>Temperature:</strong> ${station.temperature || 'N/A'}°C<div style="margin-top: 5px;"><strong>Last Update:</strong> ${station.last_update}</div><div style="font-size: 11px; color: #888; margin-top: 10px;"><a href="https://www.gov.il/he/departments/survey_of_israel/govil-landing-page" target="_parent" style="color: #666; text-decoration: none;">© 2025 Survey of Israel. All rights reserved.</a></div>`,
                                forecastHTML
                            ]);
                        } else {
                            tooltips.push(`${station.Station} - ${station.latest_value}m`);
                            bubbleHTMLParameters.push([
                                station.Station,
                                `<strong>Sea Level:</strong> ${station.latest_value} m`,
                                `<strong>Temperature:</strong> ${station.temperature || 'N/A'}°C<div style="margin-top: 5px;"><strong>Last Update:</strong> ${station.last_update}</div><div style="font-size: 11px; color: #888; margin-top: 10px;"><a href="https://www.gov.il/he/departments/survey_of_israel/govil-landing-page" target="_parent" style="color: #666; text-decoration: none;">© 2025 Survey of Israel. All rights reserved.</a></div>`,
                                '' // Empty string for stations without forecast
                            ]);
                        }
                    });
                    
                    // Add Sea of Galilee forecast marker (standalone)
                    const seaOfGalilee = forecastData.find(f => f.name_eng === 'Sea of Galilee');
                    if (seaOfGalilee) {
                        const coords = seaOfGalilee.coordinates;
                        const itm = convertToITM(coords.lng, coords.lat);
                        wkts.push(`POINT(${itm.x} ${itm.y})`);
                        names.push(`forecast_sea_of_galilee`);
                        symbols.push({
                            url: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#2196F3"/></svg>'),
                            width: 32,
                            height: 32
                        });
                        
                        const currentForecast = seaOfGalilee.forecasts[0];
                        const waveHeight = translateWaveHeight(currentForecast?.elements?.wave_height || 'N/A');
                        const windInfo = translateWindInfo(currentForecast?.elements?.wind || 'N/A');
                        
                        tooltips.push(`${seaOfGalilee.name_eng} - Wave Forecast`);
                        bubbleHTMLParameters.push([
                            seaOfGalilee.name_eng,
                            `<strong>Wave Height:</strong> ${waveHeight}`,
                            `<strong>Sea Temperature:</strong> ${currentForecast?.elements?.sea_temperature || 'N/A'}°C`,
                            `<strong>Wind:</strong> ${windInfo}<div style="font-size: 12px; color: #7f8c8d; margin-top: 10px;"><strong>Forecast Period:</strong><br>${currentForecast?.from || 'N/A'} - ${currentForecast?.to || 'N/A'}</div><div style="font-size: 11px; color: #888; margin-top: 10px;"><a href="https://ims.gov.il/he/coasts" target="_parent" style="color: #666; text-decoration: none;">IMS Forecast ©</a></div>`
                        ]);
                    }
                    
                    govmap.displayGeometries({
                        wkts: wkts,
                        names: names,
                        geometryType: govmap.geometryType.POINT,
                        symbols: symbols,
                        clearExisting: true,
                        data: {
                            tooltips: tooltips,
                            bubbleHTML: `
                                <div style="font-family: Arial, sans-serif; padding: 15px; min-width: 250px; direction: ltr; text-align: left;">
                                    <h4 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; direction: ltr; text-align: left;">{0}</h4>
                                    <div style="margin: 8px 0; direction: ltr; text-align: left;">{1}</div>
                                    <div style="margin: 8px 0; direction: ltr; text-align: left;">{2}</div>
                                    {3}
                                </div>
                            `,
                            bubbleHTMLParameters: bubbleHTMLParameters
                        }
                    });
                };
                
                const fetchAndDisplayStations = (endDate) => {
                    const apiUrl = window.location.protocol + '//' + window.location.host;
                    fetch(`${apiUrl}/stations/map?end_date=${endDate}`)
                        .then(response => response.json())
                        .then(data => {
                            if (!Array.isArray(data) || data.length === 0) {
                                throw new Error('No station data');
                            }
                            stationsData = data;
                            displayAllMarkers();
                            showMap();
                        })
                        .catch(error => showError('Failed: ' + error.message));
                };
                
                const fetchWaveForecast = () => {
                    const apiUrl = window.location.protocol + '//' + window.location.host;
                    fetch(`${apiUrl}/sea-forecast`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.locations) {
                                forecastData = data.locations;
                                displayAllMarkers();
                            }
                        })
                        .catch(error => console.warn('Wave forecast fetch failed:', error));
                };
                
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'UPDATE_DATE') {
                        fetchAndDisplayStations(event.data.payload);
                    }
                });
                
                const today = new Date().toISOString().split('T')[0];
                fetchAndDisplayStations(today);
                fetchWaveForecast();
                
                mapInstance = govmap.createMap("map", {
                    token: govmap.token,
                    layers: [],
                    center: { x: 176505, y: 662250 },
                    zoom: 0,
                    basemap: '2'
                });
                
            } catch (error) {
                showError('Init failed: ' + error.message);
            }
            }, 1000); // 1 second delay for Edge
        };
        
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'UPDATE_STATIONS') {
                stationsData = event.data.stations;
            }
        });
    </script>
</body>
</html>