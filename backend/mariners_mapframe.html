<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariners Forecast Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .forecast-popup { min-width: 200px; font-size: 12px; }
        .forecast-popup h4 { margin: 0 0 10px 0; color: #2c5aa0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .forecast-item { margin-bottom: 8px; padding: 5px; background: #f8f9fa; border-radius: 3px; }
        .forecast-period { font-weight: bold; color: #495057; margin-bottom: 3px; }
        .forecast-element { display: flex; justify-content: space-between; margin: 2px 0; }
        .element-name { font-weight: 500; color: #6c757d; }
        .element-value { color: #212529; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WIND_DIRECTION_CODES = {
            '000': 'N', '045': 'NE', '090': 'E', '135': 'SE',
            '180': 'S', '225': 'SW', '270': 'W', '315': 'NW', '360': 'N'
        };
        
        const WEATHER_CODES = {
            '1000': 'Clear', '1100': 'Mostly Clear', '1200': 'Partly Cloudy',
            '1220': 'Partly Cloudy', '1250': 'Mostly Cloudy', '1300': 'Cloudy',
            '2000': 'Fog', '4001': 'Rain', '5000': 'Snow', '8000': 'Thunderstorm'
        };
        
        function translateWind(windStr) {
            if (!windStr) return windStr;
            const parts = windStr.split('/');
            if (parts.length !== 2) return windStr;
            
            const directionPart = parts[0].trim();
            const speedPart = parts[1].trim();
            
            let directionText = directionPart;
            if (directionPart.includes('-')) {
                const [start, end] = directionPart.split('-');
                const startDir = WIND_DIRECTION_CODES[start] || start;
                const endDir = WIND_DIRECTION_CODES[end] || end;
                directionText = `${startDir}-${endDir}`;
            } else {
                directionText = WIND_DIRECTION_CODES[directionPart] || directionPart;
            }
            
            return `${directionText} (${speedPart} km/h)`;
        }
        
        function translateWeatherCode(weatherCode) {
            if (!weatherCode) return weatherCode;
            return WEATHER_CODES[weatherCode] || weatherCode;
        }
        
        function translateSeaStatus(seaStr) {
            if (!seaStr) return seaStr;
            const parts = seaStr.split(' / ');
            if (parts.length !== 2) return seaStr;
            const code = parts[0].trim();
            const height = parts[1].trim();
            const seaCodes = {'10': 'Calm', '20': 'Smooth', '30': 'Slight', '40': 'Light', '50': 'Slight', '60': 'Moderate', '70': 'Rough', '80': 'Very Rough', '90': 'High', '95': 'Very High'};
            const description = seaCodes[code] || code;
            return `${description} (${height} cm)`;
        }
        
        const map = L.map('map').setView([33.0, 34.0], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        const locationCoords = {
            'Delta': [32.5, 29.5],  // Deeper in Mediterranean towards Antalya
            'SouthEast Kritiko': [34.7, 25.9],  // Off Southeast Crete
            'Crusade': [32.7, 34.5]  // More to the left, off Cyprus coast
        };
        
        async function fetchMarinersData() {
            try {
                const response = await fetch('/api/mariners-forecast');
                const data = await response.json();
                
                if (data.locations) {
                    data.locations.forEach(location => {
                        const coords = locationCoords[location.name_eng];
                        if (coords) {
                            addLocationMarker(location, coords);
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching mariners data:', error);
            }
        }
        
        function addLocationMarker(location, coords) {
            let popupContent = `<div class="forecast-popup">
                <h4>${location.name_eng}</h4>
                <div style="color: #6c757d; margin-bottom: 10px;">${location.name_heb}</div>`;
            
            location.forecasts.forEach((forecast, idx) => {
                const fromDate = new Date(forecast.from).toLocaleString('en-IL', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const toDate = new Date(forecast.to).toLocaleString('en-IL', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                
                popupContent += `<div class="forecast-item">
                    <div class="forecast-period">${fromDate} - ${toDate}</div>`;
                
                Object.entries(forecast.elements).forEach(([name, value]) => {
                    if (value && value.trim()) {
                        let displayValue = value;
                        
                        if (name === 'Wind direction and speed') {
                            displayValue = translateWind(value);
                        } else if (name === 'Weather code') {
                            displayValue = translateWeatherCode(value);
                        } else if (name === 'Sea status and waves height') {
                            displayValue = translateSeaStatus(value);
                        }
                        
                        popupContent += `<div class="forecast-element">
                            <span class="element-name">${name}:</span>
                            <span class="element-value">${displayValue}</span>
                        </div>`;
                    }
                });
                
                popupContent += '</div>';
            });
            
            popupContent += '</div>';
            
            const marker = L.marker(coords, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="
                        background: #2c5aa0;
                        color: white;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    ">⚓</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'mariners-popup'
            });
        }
        
        fetchMarinersData();
    </script>
</body>
</html>