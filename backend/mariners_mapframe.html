<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariners Forecast Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .forecast-popup { min-width: 200px; font-size: 12px; }
        .forecast-popup h4 { margin: 0 0 10px 0; color: #2c5aa0; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .forecast-item { margin-bottom: 8px; padding: 5px; background: #f8f9fa; border-radius: 3px; }
        .forecast-period { font-weight: bold; color: #495057; margin-bottom: 3px; }
        .forecast-element { display: flex; justify-content: space-between; margin: 2px 0; }
        .element-name { font-weight: 500; color: #6c757d; }
        .element-value { color: #212529; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const WIND_DIRECTION_CODES = {
            '000': 'Northerly', '045': 'North Easterly', '090': 'Easterly', '135': 'South Easterly',
            '180': 'Southerly', '225': 'South Westerly', '270': 'Westerly', '315': 'North Westerly', '360': 'Northerly'
        };
        
        const WEATHER_CODES = {
            1010: "Sandstorms", 1020: "Thunderstorms", 1060: "Snow", 1070: "Light snow", 1080: "Sleet",
            1140: "Rainy", 1160: "Fog", 1220: "Partly cloudy", 1230: "Cloudy", 1250: "Clear",
            1260: "Windy", 1270: "Muggy", 1300: "Frost", 1310: "Hot", 1320: "Cold",
            1510: "Stormy", 1520: "Heavy snow", 1530: "Partly cloudy, possible rain", 1540: "Cloudy, possible rain",
            1560: "Cloudy, light rain", 1570: "Dust", 1580: "Extremely hot", 1590: "Extremely cold",
            1030: "Hail", 1040: "Blowing Snow, Blizzard, Snowdrift, Snowstorm", 1050: "Snow Showers, Flurries",
            1090: "Showers, Heavy Showers", 1100: "Occasional Showers, Scattered Showers", 1110: "Isolated Showers",
            1120: "Light Showers", 1130: "Freezing Rain", 1150: "Drizzle, Light Rain", 1170: "Mist",
            1180: "Smoke", 1190: "Haze", 1200: "Overcast", 1210: "Sunny Interval, No Rain, Clearing",
            1240: "Bright, Sunny, Fair", 1280: "Dry", 1290: "Freezing", 1330: "Warming", 1340: "Cooling"
        };
        
        const SEA_STATE_CODES = {
            10: "Calm", 20: "Rippled", 30: "Smooth", 40: "Smooth to slight", 50: "Slight",
            55: "Slight to moderate", 60: "Moderate", 70: "Moderate to rough", 80: "Rough",
            90: "Rough to very rough", 110: "Very rough", 120: "Very rough to high", 130: "High",
            140: "High to very high", 150: "Very high", 160: "Phenomenal",
            161: "Smooth. Becoming slight.", 162: "Smooth. Becoming slight during day time.",
            163: "Smooth. Becoming tomorrow slight to moderate.", 164: "Smooth. Becoming slight to moderate",
            165: "Smooth to slight. Becoming moderate", 166: "Smooth at west coast, slight at east coast",
            167: "Smooth to slight. Becoming slight to moderate.", 168: "Slight. Becoming moderate.",
            169: "Smooth to slight. Becoming moderate to rough.", 170: "Slight over Western bank, moderate over Eastern bank.",
            171: "Slight to moderate. Becoming moderate to rough"
        };
        
        function translateWindDirection(direction) {
            const dirStr = String(direction).padStart(3, '0');
            return WIND_DIRECTION_CODES[dirStr] || direction;
        }
        
        function translateWind(windStr) {
            if (!windStr || typeof windStr !== 'string') return windStr;
            const parts = windStr.split('/');
            if (parts.length !== 2) return windStr;
            
            const [directions, speeds] = parts;
            
            let translatedDirections = directions;
            if (directions.includes('-')) {
                const [dir1, dir2] = directions.split('-');
                const trans1 = translateWindDirection(dir1.padStart(3, '0'));
                const trans2 = translateWindDirection(dir2.padStart(3, '0'));
                translatedDirections = `${trans1}-${trans2}`;
            } else {
                translatedDirections = translateWindDirection(directions.padStart(3, '0'));
            }
            
            return `${translatedDirections} (${speeds.trim()} km/h)`;
        }
        
        function translateWeatherCode(code) {
            const numCode = parseInt(code);
            return WEATHER_CODES[numCode] || code;
        }
        
        function translateSeaStateCode(code) {
            const numCode = parseInt(code);
            return SEA_STATE_CODES[numCode] || code;
        }
        
        function translateSeaStatus(seaStr) {
            if (!seaStr || typeof seaStr !== 'string') return seaStr;
            const parts = seaStr.split(' / ');
            if (parts.length !== 2) {
                return translateSeaStateCode(seaStr.trim());
            }
            const [code, actualHeight] = parts;
            const translatedCode = translateSeaStateCode(code.trim());
            return `${translatedCode} (${actualHeight.trim()} cm)`;
        }
        
        function translateSwellInfo(swellStr) {
            if (!swellStr || typeof swellStr !== 'string') return swellStr;
            const parts = swellStr.split(' / ');
            if (parts.length !== 2) {
                const code = swellStr.trim();
                const windDir = translateWindDirection(code.padStart(3, '0'));
                if (windDir !== code) {
                    return windDir;
                }
                return translateSeaStateCode(code);
            }
            
            const [code, actualHeight] = parts;
            const codeStr = code.trim();
            
            const windDir = translateWindDirection(codeStr.padStart(3, '0'));
            if (windDir !== codeStr) {
                return `${windDir} (${actualHeight.trim()} cm)`;
            }
            
            const translatedCode = translateSeaStateCode(codeStr);
            return `${translatedCode} (${actualHeight.trim()} cm)`;
        }
        
        const map = L.map('map').setView([33.0, 34.0], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        const locationCoords = {
            'Delta': [32.5, 29.5],  // Deeper in Mediterranean towards Antalya
            'SouthEast Kritiko': [34.7, 25.9],  // Off Southeast Crete
            'Crusade': [32.7, 34.5]  // More to the left, off Cyprus coast
        };
        
        async function fetchMarinersData() {
            try {
                const response = await fetch('/api/mariners-forecast');
                const data = await response.json();
                
                if (data.locations) {
                    data.locations.forEach(location => {
                        const coords = locationCoords[location.name_eng];
                        if (coords) {
                            addLocationMarker(location, coords);
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching mariners data:', error);
            }
        }
        
        function addLocationMarker(location, coords) {
            let popupContent = `<div class="forecast-popup">
                <h4>${location.name_eng}</h4>
                <div style="color: #6c757d; margin-bottom: 10px;">${location.name_heb}</div>`;
            
            location.forecasts.forEach((forecast, idx) => {
                const fromDate = new Date(forecast.from).toLocaleString('en-IL', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const toDate = new Date(forecast.to).toLocaleString('en-IL', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                
                popupContent += `<div class="forecast-item">
                    <div class="forecast-period">${fromDate} - ${toDate}</div>`;
                
                Object.entries(forecast.elements).forEach(([name, value]) => {
                    if (value && value.trim()) {
                        let displayValue = value;
                        
                        if (name === 'Wind direction and speed') {
                            displayValue = translateWind(value);
                        } else if (name === 'Weather code') {
                            displayValue = translateWeatherCode(value);
                        } else if (name === 'Sea status and waves height') {
                            displayValue = translateSeaStatus(value);
                        } else if (name === 'Swell') {
                            displayValue = translateSwellInfo(value);
                        } else if (name === 'Pressure') {
                            displayValue = `${value} hPa`;
                        } else if (name === 'Visibility') {
                            displayValue = `${value} nm`;
                        }
                        
                        popupContent += `<div class="forecast-element">
                            <span class="element-name">${name}:</span>
                            <span class="element-value">${displayValue}</span>
                        </div>`;
                    }
                });
                
                popupContent += '</div>';
            });
            
            popupContent += '</div>';
            
            const marker = L.marker(coords, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="
                        background: #2c5aa0;
                        color: white;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 12px;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    ">⚓</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'mariners-popup'
            });
        }
        
        fetchMarinersData();
    </script>
</body>
</html>